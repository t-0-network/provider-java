name: Publish

on:
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+'

jobs:
  publish:
    name: Build and Upload to Maven Central
    runs-on: blacksmith-4vcpu-ubuntu-2404
    permissions:
      contents: 'read'
      id-token: 'write'
    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: useblacksmith/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: useblacksmith/setup-gradle/setup-gradle@v5

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: 'projects/562407396493/locations/global/workloadIdentityPools/github-actions-pool/providers/github-actions-provider'
          service_account: 'github-actions-sa@tzero-network.iam.gserviceaccount.com'

      - name: Get GPG key from Secret Manager
        id: secrets
        uses: google-github-actions/get-secretmanager-secrets@v3
        with:
          secrets: |-
            gpg_key:tzero-network/gpg-prod

      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Build
        run: ./gradlew build --no-daemon

      # === NMCP Publishing (active) ===
      - name: Publish to Maven Central
        run: ./gradlew publishAggregationToCentralPortal --no-daemon
        env:
          GPG_PRIVATE_KEY: ${{ steps.secrets.outputs.gpg_key }}
          MAVEN_CENTRAL_USERNAME: ${{ secrets.OSSRH_USERNAME }}
          MAVEN_CENTRAL_PASSWORD: ${{ secrets.OSSRH_PASSWORD }}

      # === JReleaser Publishing (disabled - uncomment to re-enable) ===
      # - name: Stage artifacts
      #   run: ./gradlew :sdk:publishMavenJavaPublicationToStagingRepository :cli:publishMavenPublicationToStagingRepository --no-daemon
      #   env:
      #     GPG_PRIVATE_KEY: ${{ steps.secrets.outputs.gpg_key }}
      #
      # - name: Deploy to Maven Central
      #   run: ./gradlew jreleaserDeploy --no-daemon
      #   env:
      #     JRELEASER_MAVENCENTRAL_USERNAME: ${{ secrets.OSSRH_USERNAME }}
      #     JRELEASER_MAVENCENTRAL_PASSWORD: ${{ secrets.OSSRH_PASSWORD }}
      #     JRELEASER_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  verify:
    name: Verify Publication
    needs: publish
    runs-on: blacksmith-2vcpu-ubuntu-2404

    steps:
      - name: Wait for Maven Central availability
        env:
          VERSION: ${{ needs.publish.outputs.version }}
        run: |
          echo "Checking Maven Central for version: $VERSION"

          MAX_ATTEMPTS=60
          DELAY=30
          URL="https://repo1.maven.org/maven2/network/t-0/provider-sdk-java/${VERSION}/provider-sdk-java-${VERSION}.pom"

          for i in $(seq 1 $MAX_ATTEMPTS); do
            echo "Attempt $i/$MAX_ATTEMPTS - checking $URL"

            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$URL")

            if [ "$HTTP_CODE" = "200" ]; then
              echo "Published to Maven Central!"
              exit 0
            fi

            echo "Not available yet (HTTP $HTTP_CODE), waiting ${DELAY}s..."
            sleep $DELAY
          done

          echo "Timeout waiting for publication"
          echo "Check: https://central.sonatype.com/publishing/deployments"
          exit 1
