name: Publish

on:
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+'

jobs:
  publish:
    name: Build and Upload to Maven Central
    runs-on: blacksmith-4vcpu-ubuntu-2404
    permissions:
      contents: 'read'
      id-token: 'write'
    outputs:
      deployment_id: ${{ steps.deploy.outputs.deployment_id }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: useblacksmith/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: useblacksmith/setup-gradle/setup-gradle@v5

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: 'projects/562407396493/locations/global/workloadIdentityPools/github-actions-pool/providers/github-actions-provider'
          service_account: 'github-actions-sa@tzero-network.iam.gserviceaccount.com'

      - name: Get GPG key from Secret Manager
        id: secrets
        uses: google-github-actions/get-secretmanager-secrets@v3
        with:
          secrets: |-
            gpg_key:tzero-network/gpg-prod

      - name: Build
        run: ./gradlew build --no-daemon

      - name: Stage artifacts
        run: ./gradlew :sdk:publishMavenJavaPublicationToStagingRepository :cli:publishMavenPublicationToStagingRepository --no-daemon
        env:
          GPG_PRIVATE_KEY: ${{ steps.secrets.outputs.gpg_key }}

      - name: Deploy to Maven Central
        id: deploy
        run: |
          ./gradlew jreleaserDeploy --no-daemon

          # Find and display JReleaser output
          echo "Looking for JReleaser output files..."
          find build -name "*.properties" -o -name "output*" 2>/dev/null || true

          # Try multiple possible locations for deployment ID
          DEPLOYMENT_ID=""
          for props_file in build/jreleaser/output.properties build/jreleaser/trace/output.properties; do
            if [ -f "$props_file" ]; then
              echo "Found: $props_file"
              cat "$props_file"
              DEPLOYMENT_ID=$(grep -i 'deploymentId' "$props_file" | cut -d'=' -f2 | tr -d ' ' || true)
              if [ -n "$DEPLOYMENT_ID" ]; then
                break
              fi
            fi
          done

          # Also try to extract from JReleaser logs
          if [ -z "$DEPLOYMENT_ID" ]; then
            echo "Searching JReleaser logs for deployment ID..."
            DEPLOYMENT_ID=$(find build -name "*.log" -exec grep -h "deploymentId" {} \; 2>/dev/null | head -1 | grep -oE '[0-9a-f-]{36}' || true)
          fi

          if [ -n "$DEPLOYMENT_ID" ]; then
            echo "deployment_id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT
            echo "Deployment ID: $DEPLOYMENT_ID"
          else
            echo "Warning: Could not find deployment ID"
          fi
        env:
          JRELEASER_MAVENCENTRAL_USERNAME: ${{ secrets.OSSRH_USERNAME }}
          JRELEASER_MAVENCENTRAL_PASSWORD: ${{ secrets.OSSRH_PASSWORD }}
          JRELEASER_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  verify:
    name: Verify Publication
    needs: publish
    runs-on: blacksmith-2vcpu-ubuntu-2404
    if: needs.publish.outputs.deployment_id != ''

    steps:
      - name: Wait for Maven Central publication
        env:
          DEPLOYMENT_ID: ${{ needs.publish.outputs.deployment_id }}
          MAVEN_USERNAME: ${{ secrets.OSSRH_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.OSSRH_PASSWORD }}
        run: |
          echo "Checking publication status for deployment: $DEPLOYMENT_ID"

          # Create auth token (base64 encoded username:password)
          AUTH_TOKEN=$(echo -n "$MAVEN_USERNAME:$MAVEN_PASSWORD" | base64)

          MAX_ATTEMPTS=60
          DELAY=30

          for i in $(seq 1 $MAX_ATTEMPTS); do
            echo "Attempt $i/$MAX_ATTEMPTS..."

            RESPONSE=$(curl -s --request POST \
              --header "Authorization: Bearer $AUTH_TOKEN" \
              "https://central.sonatype.com/api/v1/publisher/status?id=$DEPLOYMENT_ID")

            STATE=$(echo "$RESPONSE" | jq -r '.deploymentState // empty')

            echo "Current state: $STATE"

            if [ "$STATE" = "PUBLISHED" ]; then
              echo "✅ Successfully published to Maven Central!"
              exit 0
            elif [ "$STATE" = "FAILED" ]; then
              echo "❌ Publication failed!"
              echo "$RESPONSE" | jq
              exit 1
            fi

            if [ $i -lt $MAX_ATTEMPTS ]; then
              echo "Waiting ${DELAY}s before next check..."
              sleep $DELAY
            fi
          done

          echo "⚠️ Timeout waiting for publication. Last state: $STATE"
          echo "Check status manually at: https://central.sonatype.com/publishing/deployments"
          exit 1
